<ion-toolbar color="primary">
  <ion-buttons slot="start">
    <ion-back-button default-href="#"></ion-back-button>
  </ion-buttons>
  <ion-title class="font-bold" *ngIf="!idContractToEdit">Criar contrato</ion-title>
  <ion-title class="font-bold" *ngIf="idContractToEdit">Editar contrato</ion-title>
</ion-toolbar>

<ion-content *ngIf="contract">
  <div class="content">
    <div>
      <ng-form #form="ngForm">
        <div class="mt-3 flex flex-col gap-3">
          <ion-input class="custom" placeholder="Identificador" name="identifier" [(ngModel)]="contract.identifier"
            required></ion-input>
          <ion-input class="custom" placeholder="CEP" (ionChange)="onCepChange()" [maskito]="cepMask"
            [maskitoElement]="maskPredicate" name="cep" [(ngModel)]="contract.cep" required></ion-input>
          <ion-input class="custom" placeholder="Bairro" name="neighborhood" [(ngModel)]="contract.neighborhood"
            required></ion-input>
          <ion-input class="custom" placeholder="Rua" name="street" [(ngModel)]="contract.street" required></ion-input>
          <ion-input class="custom" placeholder="Número" name="numberHouse" [(ngModel)]="contract.numberHouse"
            required></ion-input>
          <ion-input class="custom" placeholder="Complemento" name="complement"
            [(ngModel)]="contract.complement"></ion-input>

          <ion-input class="date" type="date" placeholder="Data final da locação" name="endDateLocate"
            [(ngModel)]="contract.endDateLocate"></ion-input>

          <div class="select-input">
            <ion-select interface="popover" placeholder="Contato" name="id_contact" [(ngModel)]="contract.contactId"
              required>
              <ion-select-option class="text-white" *ngFor="let contact of contacts" [value]="contact.id">
                <ion-label color="light">{{contact.name}}</ion-label>
              </ion-select-option>
            </ion-select>
          </div>

          <div class="select-input">
            <ion-select (ionChange)="handleChangeAsset($event)" interface="popover"
              placeholder="Selecione os equipamentos" name="assetes_ids" [(ngModel)]="contract.assets" required
              [multiple]="true">
              <ion-select-option class="text-white" *ngFor="let asset of assets" [value]="asset">
                <ion-label>{{asset.name}}</ion-label>
              </ion-select-option>
            </ion-select>
          </div>

          <div *ngIf="contract.assets.length > 0">
            <p class="text-end mr-5 text-sm text-gray-500">Quantidade</p>
            <div class="bg-[color:var(--ion-color-primary)] border-2 border-gray-600 mx-2 rounded-md my-2"
              *ngFor="let asset of contract.assets">
              <div class="mx-5 flex items-center justify-between">
                <p class="mr-5 text-white">{{ asset.name }}</p>
                <div>
                  <ion-input class="assets" placeholder="Quantidade" [name]="asset.name" [(ngModel)]="asset.quantity"
                    type="number"></ion-input>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-center mt-5 mb-5">
          <omni-button type="primary" title="Termos de contrato" [disabled]="!verifyToSubmit(1)"
            (click)="verifyToSubmit(1) ? isOpenContractTerms = true : null"></omni-button>
        </div>
      </ng-form>
    </div>
  </div>
</ion-content>


<ion-modal [isOpen]="isOpenContractTerms">
  <ng-template>
    <ion-toolbar color="primary">
      <ion-buttons slot="end">
        <ion-button color="light" (click)=" isOpenContractTerms=false">
          <ion-icon size="large" slot="icon-only" name="close-circle-sharp"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>Assinar contrato</ion-title>
    </ion-toolbar>

    <ion-content>
      <div class="text-center mt-3 text-white">
        <div>
          <strong class="text-xl">Termos do contrato</strong>
        </div>

        <div class="m-5">
          <p>{{contractTerms}}</p>
        </div>
        <div *ngIf="contract?.assets?.length > 0">
          <p>Os seguinte termos se referem à locação dos seguintes equipamentos:</p>
          <table class="my-5">
            <thead>
              <tr>
                <th class="w-80">Nome</th>
                <th>Quant.</th>
                <th>Valor Unitário</th>
                <th>Valor Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let asset of contract.assets">
                <td>{{ asset.name }}</td>
                <td>{{ asset.quantity }}</td>
                <td>{{ "R$" + asset.assetCategory.value + ",00" }}</td>
                <td>{{ "R$" + totalValueCalculator(asset.quantity, asset.assetCategory.value) + ",00"}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center m-3 text-white">
        <p>Concorda com os termos acima:</p>
        <ion-checkbox color="light" (ionChange)="isAgreed = true" class="w-8 h-8 mx-2"></ion-checkbox>
      </div>

      <div>
        <img *ngIf="contract.image" [src]="contract.image" class="w-full h-60 bg-white">
        <omni-signature-pad *ngIf="!contract.image" (imageBase64Emitter)="getImage($event)"></omni-signature-pad>
      </div>

      <omni-button class="flex justify-center mt-5" type="primary"
        [title]="idContractToEdit ? 'Editar contrato' : 'Criar contrato'" [disabled]="!verifyToSubmit(2)"
        (click)="verifyToSubmit(2) ? onSubmit() : null"></omni-button>

    </ion-content>
  </ng-template>
</ion-modal>

<!--SKELETON LOADING-->
<ion-content *ngIf="!contract">
  <div class="content">
    <div>
      <ng-form #form="ngForm">
        <div class="mt-4 flex flex-col items-center gap-2">
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
        </div>
        <div class="flex justify-center mt-4 mb-5">
          <ion-skeleton-text [animated]="true"
            style="width: 90vw; height: 50px; border-radius: 5px;"></ion-skeleton-text>
        </div>
      </ng-form>
    </div>

  </div>
</ion-content>